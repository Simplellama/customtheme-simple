{% if product.metafields.bookthatapp.config or product.metafields.bookthatapp.json_config %}
    {% assign product_in_cart = false %}

    {% for item in cart.items %}
        {% if item.product.handle == product.handle %}
            {% assign product_in_cart = true %}
        {% endif %}
    {% endfor %}

    <div class="booking-form" data-product-id={{ product.id }}>
        {% if product_in_cart %}
            <p id="booking-guard-{{ product.handle }}">
                <a href="/cart">
                    View Booking
                </a>.
            </p>
        {% else %}
            <div>
                {% capture attribute %}booking-start{% endcapture %}
            
                <label for="{{ attribute }}-{{ product.handle }}">
                    From:
                </label>
                <input id="{{ attribute }}-{{ product.handle }}" type="text" name="properties[From]"
                       class="datepicker bta required bta-load-enable bta-dp-start" disabled="disabled"
                       data-handle="{{ product.handle }}"
                       data-variant="{{ product.selected_or_first_available_variant.id }}"
                       {% if product.metafields.bookthatapp.json_config %}
                           data-bta-product-config='{{ product.metafields.bookthatapp.json_config }}'
                       {% else %}
                           data-bta-product-config="{{ product.metafields.bookthatapp.config }}"
                       {% endif %}
                       data-bta-range-partner-id="#booking-finish-{{ product.handle }}"
                       placeholder="Select date..."/>
            </div>
            
            <div>
                {% capture attribute %}booking-finish{% endcapture %}
            
                <label for="{{ attribute }}-{{ product.handle }}">
                    To:
                </label>
                <input id="{{ attribute }}-{{ product.handle }}" type="text" name="properties[To]"
                       class="datepicker bta required bta-load-enable bta-dp-finish" disabled="disabled"
                       data-bta-range-partner-id="#booking-start-{{ product.handle }}"
                       placeholder="Select date..."/>
            </div>
            
            <div class="bta-booking-fields"></div>
            
            <div class="bta-validation-messages" style="display:none">
                <p class="bta-validation-date-missing">
                    Please select a from and to date.
                </p>
            </div>
        {% endif %}
    </div>

    <script>
        const initializeBookThatAppBookingForms = () => {
            if(document.getElementById('bta-product-widget')) { return }

            var sessionKey = "Product-{{ product.handle }}-added";

            if (sessionStorage.getItem(sessionKey)) {
                // reload the product page if user click the back button
                sessionStorage.removeItem(sessionKey);
                window.location.reload();
            }

            const elementToReplace = document.getElementById('booking-form');

            if (elementToReplace) {
                elementToReplace.outerHTML = `{{ content }}`
            }

            {% if product_in_cart %}
                $('#booking-guard-{{ product.handle }}').closest('form[action^="/cart/add"]')
                                                        .find('input:submit, button:submit, .hide-if-in-cart')
                                                        .hide();
            {% endif %}

            var forms = document.forms;
            for (var x = 0; x < forms.length; x++) {
                if (forms[x].action.indexOf('/cart/add') > -1) {
                    // prevent form submit until bta has finished loading
                    forms[x].addEventListener("submit", function (event) {
                        // check if bta has loaded
                        if (!this.classList.contains("bta-active")) {
                            event.preventDefault();
                        }
                    }, true);
                }
            }

            var bta = { productId: {{ product.id }} }
        }

        document.addEventListener('DOMContentLoaded', initializeBookThatAppBookingForms);
    </script>
{% endif %}